rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Helper function to check if user can invite
    function canInvite() {
      return request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.canInvite == true ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true);
    }

    // Users collection
    match /users/{userId} {
      // Allow limited listing for registration check (first user detection)
      // Unauthenticated users can only check if collection is empty (limit 1)
      allow list: if request.query.limit <= 1 ||
        (request.auth != null && request.query.limit <= 50);

      // Allow reading individual user documents for authenticated users
      allow get: if request.auth != null;

      // Allow creating own user document (during registration)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow updating own user document only
      allow update: if request.auth != null && request.auth.uid == userId;

      // No delete allowed for users
      allow delete: if false;
    }

    // Invitations collection
    match /invitations/{invitationId} {
      // Allow reading invitations by code for registration validation (unauthenticated)
      // Authenticated users can read their own invitations
      allow get: if request.auth != null &&
        resource.data.createdBy == request.auth.uid;

      // Allow listing for:
      // 1. Unauthenticated users validating invitation code (limit 1)
      // 2. Authenticated users viewing their own invitations
      allow list: if request.query.limit <= 1 ||
        (request.auth != null && resource.data.createdBy == request.auth.uid);

      // Only allow creating if user has invite permission
      allow create: if request.auth != null && canInvite() &&
        request.resource.data.createdBy == request.auth.uid;

      // Allow marking as used - for registration process (newly authenticated user)
      allow update: if request.auth != null &&
        resource.data.isUsed == false &&
        request.resource.data.isUsed == true;

      // Only creator can delete unused invitations
      allow delete: if request.auth != null &&
        resource.data.createdBy == request.auth.uid &&
        resource.data.isUsed == false;
    }

    // Conversations collection
    match /conversations/{conversationId} {
      // Helper to check if user is participant
      function isParticipant() {
        return request.auth != null &&
          request.auth.uid in resource.data.participants;
      }

      function willBeParticipant() {
        return request.auth != null &&
          request.auth.uid in request.resource.data.participants;
      }

      // Allow read only if user is participant
      allow read: if isParticipant();

      // Allow create if user will be participant
      allow create: if request.auth != null && willBeParticipant();

      // Allow update only if user is participant
      allow update: if isParticipant();

      // Allow delete only if user is participant or admin
      allow delete: if isParticipant() || isAdmin();
    }

    // App meta collection (for admin status tracking)
    match /app_meta/{docId} {
      // Allow unauthenticated read for registration flow
      allow read: if true;
      // Only allow initial creation, no updates from client
      allow create: if request.auth != null && !exists(/databases/$(database)/documents/app_meta/$(docId));
      allow update, delete: if false;
    }

    // Conversations collection (reopened for messages subcollection)
    match /conversations/{conversationId} {
      // Messages subcollection
      match /messages/{messageId} {
        // Check if user is participant of parent conversation
        function isConversationParticipant() {
          return request.auth != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        }

        // Allow read/write only for conversation participants
        allow read: if isConversationParticipant();

        // Allow creating messages only if sender is the current user and is participant
        allow create: if isConversationParticipant() &&
          request.resource.data.senderId == request.auth.uid;

        // Allow updating own messages only (for editing)
        allow update: if isConversationParticipant() &&
          resource.data.senderId == request.auth.uid;

        // Allow message deletion only for conversation participants (when deleting conversation)
        allow delete: if isConversationParticipant();
      }
    }
  }
}
